# vim:foldmethod=marker

# Miscellaneous {{{
# allow mouse use
set-option -g mouse on
# let colors pass through
set -g default-terminal "tmux-256color"
# don't allow programs running in a pane to change the window title with an escape sequence
set-option -g allow-rename off
# Let tmux automatically rename windows, unless I manually set a name for that window
set -g automatic-rename on
set-option -g renumber-windows on
bind-key -n MouseDrag1Status swap-window -d -t=
setw -g aggressive-resize on
set -s escape-time 0
# have window indices start from 1
set -g base-index 1
set -g prefix C-Space
set -g pane-border-format ''
set-option -g display-time 1500
set-option -g set-titles on
set-option -g set-titles-string '#T'
# By setting a default-command, tmux won't use its default behaviour which creates a login shell
# for new windows. The 'exec' is there so that tmux-resurrect works properly.
set -g default-command "exec ${SHELL}"
# When a client becomes active, run attach-session which will update the environment
set-hook -g client-active attach-session
set-option -g allow-passthrough on
# The output from ':checkhealth' in neovim says 'autoread' might not work if this isn't set.
set-option -g focus-events on
set-option -g set-clipboard external

# Create a new window using the current pane's directory as the new window's directory
bind t new-window -c "#{pane_current_path}"
# split panes horizontally/vertically using the current pane's directory as the new pane's directory
bind '|' split-window -h -c '#{pane_current_path}'
bind '-' split-window -v -c '#{pane_current_path}'

# Border characters for statusbar indicators
if-shell -F "$NERDFONT_ENABLE" {
    set -g @left_symbol "\ue0b6"
    set -g @right_symbol "\ue0b4"
} {
    set -g @left_symbol "â–ˆ"
    set -g @right_symbol "â–ˆ"
}

# reload
if-shell -F "$NERDFONT_ENABLE" {
    set -g @reload_symbol "\ue348 "
} {
    set -g @reload_symbol "âŸ³"
}
bind r run-shell -b 'tmux source ~/.tmux.conf\; set @mode_indicator_custom_prompt "#[bold bg=#{@bgcolor} fg=#{@standoutcolor}]#{@left_symbol}#[reverse]#{@reload_symbol} RELOADED#[noreverse]#{@right_symbol}"\; refresh-client -S; sleep 1; tmux set -u @mode_indicator_custom_prompt\; refresh-client -S'

# navigate windows
bind-key -n M-H previous-window
bind-key -n M-L next-window
# toggle zoom on pane
bind-key -n M-m resize-pane -Z
# change highlight color
set -g mode-style "fg=terminal,bg=colour8"
set -g fill-character 'â•±'
bind-key -n M-s choose-tree -ZsN
# resize panes
bind-key -n M-Left resize-pane -L
bind-key -n M-Right resize-pane -R
bind-key -n M-Up resize-pane -U
bind-key -n M-Down resize-pane -D
# switch windows with alt+<window number>
bind-key -n M-1 select-window -t 1
bind-key -n M-2 select-window -t 2
bind-key -n M-3 select-window -t 3
bind-key -n M-4 select-window -t 4
bind-key -n M-5 select-window -t 5
bind-key -n M-6 select-window -t 6
bind-key -n M-7 select-window -t 7
bind-key -n M-8 select-window -t 8
bind-key -n M-9 select-window -t 9

# popup
bind -n M-t if-shell -F '#{==:#{session_name},popup}' {
   detach-client
} {
   display-popup -E -d '#{pane_current_path}' -w100% -h100% -- "tmux attach -t popup || tmux new -s popup"
}
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n M-h if-shell "$is_vim" 'send-keys M-h'  'select-pane -L'
bind-key -n M-j if-shell "$is_vim" 'send-keys M-j'  'select-pane -D'
bind-key -n M-k if-shell "$is_vim" 'send-keys M-k'  'select-pane -U'
bind-key -n M-l if-shell "$is_vim" 'send-keys M-l'  'select-pane -R'
# }}}

# Aesthetics {{{
set -g @activecolor 'cyan'
set -g @bordercolor 'colour8'
set -g @standoutcolor 'yellow'
set -g @bgcolor 'terminal'

# status bar configuration
set -g status-position bottom
set -g pane-border-status bottom

# Panes
set -g pane-border-lines single
set -g pane-active-border-style "fg=terminal,dim"
set -g pane-border-style "fg=#{@bordercolor}"

# Clock Mode
set -g clock-mode-colour 'cyan'
set -g clock-mode-style 24

# Messages
set -g message-style "bg=#{@bgcolor},fg=#{@standoutcolor}"

# Bars
set -g status-interval 1
set -g status on
set -g status-style "bg=#{@bgcolor},fg=#{@bordercolor}"

if-shell -F "$NERDFONT_ENABLE" {
    set -g @internet_connected_symbol "\uf1eb "
    set -g @internet_disconnected_symbol "\uf1eb "
    set -g @new_window_symbol "\uf44d "
} {
    set -g @internet_connected_symbol "ðŸœƒ "
    set -g @internet_disconnected_symbol "ðŸœƒ "
    set -g @new_window_symbol "ï¼‹"
}
set -g status-right "#{?#{m/r:tty[0-9]*,#{client_tty}},#{?#{battery_percentage},#{battery_color_charge_fg}#{battery_icon_charge}#{battery_color_status_fg}#{battery_icon_status}#[fg=terminal] #{battery_percentage}#[fg=colour3],} #{online_status}  #[fg=colour8]â”‚#[fg=terminal] %a#, %b %-e %H:%M,#[bg=terminal,fg=terminal,bold] #{@new_window_symbol}#[bg=terminal,fg=colour0]} "
set -g status-right-length 999
bind-key -T root MouseDown1StatusRight new-window -c "#{pane_current_path}"

set -g status-left "#[bg=#{@bgcolor},fg=terminal] #S #{tmux_mode_indicator}"
set -g status-left-length 999

# Windows
set -g status-justify absolute-centre
set -g window-status-format "#[fg=colour15] #I #W "
set -g window-status-current-format " #[fg=colour6]#I#[fg=terminal] #W#{?window_zoomed_flag,#[fg=#{@standoutcolor}#,nounderscore] [MAX],}#[nounderscore] "
set -g window-status-separator "#[bg=terminal,fg=colour8]  "

set -g popup-border-lines heavy
set -g popup-border-style "fg=#{@bordercolor}"
# }}}

# Plugins {{{
# tmux plugin manager
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'nhdaly/tmux-better-mouse-mode'
    set -g @scroll-without-changing-pane "on"
    set -g @emulate-scroll-for-no-mouse-alternate-buffer "on"

# Saves the state of tmux to a file so it can be restored later
set -g @plugin 'tmux-plugins/tmux-resurrect'
    set -g @resurrect-processes 'watch mosh-client vim nvim ssh man less tail fzf "git ui" gitui ncdu "~tmux-nest" cloudflared'
    # This strategy can restore quotes, unlike the default strategy.
    if-shell "uname | grep -q Linux" "set -g @resurrect-save-command-strategy 'linux_procfs'"

# auto reload ~/.tmux.conf when it changes
set-option -g @plugin 'b0o/tmux-autoreload'

set -g @plugin 'MunifTanjim/tmux-mode-indicator'
    if-shell -F "$NERDFONT_ENABLE" {
        set -g @prefix_symbol "\uf80b "
        set -g @copy_symbol "\uf68e "
        set -g @sync_symbol "\uf46a "
    } {
        set -g @prefix_symbol "ðŸ–® "
        set -g @copy_symbol "Â©"
        set -g @sync_symbol "ðŸ—‡ "
    }
    set -g @mode_indicator_prefix_prompt "#[bold bg=#{@bgcolor} fg=#{@standoutcolor}]#{@left_symbol}#[reverse]#{@prefix_symbol} PREFIX#[noreverse]#{@right_symbol}"
    set -g @mode_indicator_copy_prompt "#[bold bg=#{@bgcolor} fg=#{@standoutcolor}]#{@left_symbol}#[reverse]#{@copy_symbol} COPY#[noreverse]#{@right_symbol}"
    set -g @mode_indicator_sync_prompt "#[bold bg=#{@bgcolor} fg=#{@standoutcolor}]#{@left_symbol}#[reverse]#{@sync_symbol} SYNC#[noreverse]#{@right_symbol}"
    set -g @mode_indicator_empty_prompt '#[bg=#{@bgcolor}] '

set -g @plugin 'MunifTanjim/tmux-suspend'
    if-shell -F "$NERDFONT_ENABLE" {
        set -g @suspended_symbol "\uf80e "
    } {
        set -g @suspended_symbol "ðŸ–® "
    }
    set -g @suspend_key 'M-z'
    set -g @suspend_suspended_options " \
        @mode_indicator_custom_prompt::#[bold bg=#{@bgcolor} fg=#{@standoutcolor}]#{@left_symbol}#[reverse]#{@suspended_symbol} PASSTHROUGH#[noreverse]#{@right_symbol}, \
        pane-active-border-style::fg=#{@standoutcolor}, \
    "

set -g @plugin 'tmux-plugins/tmux-battery'
set -g @batt_color_charge_primary_tier8 'colour2'
set -g @batt_color_charge_primary_tier7 'colour2'
set -g @batt_color_charge_primary_tier6 'colour2'
set -g @batt_color_charge_primary_tier5 'colour11'
set -g @batt_color_charge_primary_tier4 'colour11'
set -g @batt_color_charge_primary_tier3 'colour1'
set -g @batt_color_charge_primary_tier2 'colour1'
set -g @batt_color_charge_primary_tier1 'colour1'
set -g @batt_color_status_primary_charged 'colour2'
set -g @batt_color_status_primary_charging 'colour3'
set -g @batt_color_status_primary_unknown 'terminal'
if-shell -F "$NERDFONT_ENABLE" {
    set -g @batt_icon_status_discharging " "
    set -g @batt_icon_status_charging "\uf0e7"
    set -g @batt_icon_status_charged "\uf0e7"
    set -g @batt_icon_status_unknown "\uf0e7\uf128 "
    set -g @batt_icon_charge_tier8 "\uf581"
    set -g @batt_icon_charge_tier7 "\uf580"
    set -g @batt_icon_charge_tier6 "\uf57f"
    set -g @batt_icon_charge_tier5 "\uf57e"
    set -g @batt_icon_charge_tier4 "\uf57d"
    set -g @batt_icon_charge_tier3 "\uf57b"
    set -g @batt_icon_charge_tier2 "\uf57a"
    set -g @batt_icon_charge_tier1 "\uf586"
}

set -g @plugin 'tmux-plugins/tmux-online-status'
    set -g @online_icon "#[fg=colour4] \uf1eb"
    set -g @offline_icon "#[fg=colour1] \uf1eb"

# Uses tmux-resurrect to continuously save the current tmux session at a specified interval.
# NOTE: continuum must be the last plugin listed: https://github.com/tmux-plugins/tmux-continuum#known-issues
set -g @plugin 'tmux-plugins/tmux-continuum'
    set -g @continuum-restore 'on' # Automatically restore session when tmux is started
    set -g @continuum-save-interval '1' # measured in minutes

# Start the plugin manager
run '~/.tmux/plugins/tpm/tpm'
# }}}
